##                                                                                                                                             新人入职项目学习大礼包

#### 前言：

![](res\0.png)

#### 正题：

经过前言部分的的介入，接下来步入

##### 第一步初级：

- 安装系统/配置开发环境

- 账号申请

- - 加入邮件组
  - 申请 gerrit 账号
  - 申请mantis

- 文档管理

- - gerrit托管

- 代码管理

- - 配置环境以及拉取代码
  - 代码开发
  - 代码编译

- 附录

  ​                                                             


以上知识点详情说明请见此链接：

http://10.20.40.21:8081/plugins/gitiles/Freeme/FreemeDEV/documents/+/master/Introduction/%E5%85%A5%E8%81%8C%E9%A1%BB%E7%9F%A5/%E5%85%A5%E8%81%8C%E9%A1%BB%E7%9F%A5.md



##### 第二步进阶：

- 1. git 用法

- - 1.1. git 常用命令
  - 1.2. git 高级用法

- 2. gerrit 基本用法

- - [2.1. review](http://10.20.40.21:8081/plugins/gitiles/Freeme/FreemeDEV/documents/+/master/Introduction/%E5%85%A5%E8%81%8C%E9%A1%BB%E7%9F%A5/%E6%96%B0%E5%91%98%E5%B7%A5%E5%85%A5%E8%81%8C%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD.md#2_1_review)
  - [2.2. chery-pick](http://10.20.40.21:8081/plugins/gitiles/Freeme/FreemeDEV/documents/+/master/Introduction/%E5%85%A5%E8%81%8C%E9%A1%BB%E7%9F%A5/%E6%96%B0%E5%91%98%E5%B7%A5%E5%85%A5%E8%81%8C%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD.md#2_2_chery_pick)
  - 2.3. edit commit

- 3. repo 基本用法

- - 3.1. repo 常用命令
  - 3.2. 使用 repo 拉代码

- 4. android-sdk-extra-freeme

- 5. Android Studio

- 6. Freeme 框架简介

- - [6.1. device_droi](http://10.20.40.21:8081/plugins/gitiles/Freeme/FreemeDEV/documents/+/master/Introduction/%E5%85%A5%E8%81%8C%E9%A1%BB%E7%9F%A5/%E6%96%B0%E5%91%98%E5%B7%A5%E5%85%A5%E8%81%8C%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD.md#6_1_device_droi)
  - 6.2. droi/project_xxx
  - [6.3. vendor/freeme](http://10.20.40.21:8081/plugins/gitiles/Freeme/FreemeDEV/documents/+/master/Introduction/%E5%85%A5%E8%81%8C%E9%A1%BB%E7%9F%A5/%E6%96%B0%E5%91%98%E5%B7%A5%E5%85%A5%E8%81%8C%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD.md#6_3_vendor_freeme)

- 7. 编译

- 8. 刷机

-   参考文档

以上知识点详情说明请见此链接：

http://10.20.40.21:8081/plugins/gitiles/Freeme/FreemeDEV/documents/+/master/Introduction/%E5%85%A5%E8%81%8C%E9%A1%BB%E7%9F%A5/%E6%96%B0%E5%91%98%E5%B7%A5%E5%85%A5%E8%81%8C%E5%9F%BA%E7%A1%80%E5%9F%B9%E8%AE%AD.md



##### 第三步深入：

### 安卓系统架构分类

!![](res\1.png)

目前作为安卓软件工程师在公司主要涉及到的部分为 Application 和 Application Framework ，需要了解熟悉相关代码流程及功能实现，具体模块目录可参见Freeme 框架简介，需要自行在日常工作中调试总结



### 安卓版本迭代分类

以下是表格，直观展示各个 Android 名称，版本号和 Target API 等级。

| 名称                       | 版本名      | API等级 |
| -------------------------- | ----------- | ------- |
| Android 11                 | 11.0        | 30      |
| Android 10                 | 10.0        | 29      |
| Android Pie                | 9.0         | 28      |
| Android Oreo               | 8.0-8.1     | 26-27   |
| Android Nougat             | 7.0-7.1.2   | 24-25   |
| Android Marshmallow        | 6.0-6.0.1   | 23      |
| Android Lollipop           | 5.0-5.1.1   | 21-22   |
| Android KitKat             | 4.4-4.4.4   | 19-20   |
| Android Jelly Bean         | 4.1-4.3     | 16-18   |
| Android Ice Cream Sandwich | 4.0.1-4.0.4 | 14-15   |
| Android Honeycomb          | 3.0-3.2     | 11-13   |
| Android Gingerbread        | 2.3-2.3.7   | 9-10    |
| Android Froyo              | 2.2         | 8       |
| Android Eclair             | 2.0-2.1     | 5-7     |
| Android Donut              | 1.6         | 4       |
| Android Cupcake            | 1.5         | 3       |
| -                          | 1.1         | 2       |
| -                          | 1.0         | 1       |

内部根据API等级进行代码平台仓库分类：

例如进入到repo仓库可见：/work/CODE/9863P/.repo/manifests$ ls
android-22  android-23  android-24  android-25  android-27  android-28  android-29  android-30

### 手机芯片厂商开发平台分类

MTK（联发科）、展讯、高通、华为、三星、苹果，目前内部主要基于MTK以及展讯平台源码进行项目开发



#### 开发工具分类

Andoid Studio （参见第二步进阶进行下载安装配置开发环境）、Sublime编辑器、SourceInsight代码编辑浏览器、BeyondCompare代码对比工具等

#### 远程工具分类

VNC、向日葵、TeamVIewer、putty



### 安卓知识点分类

安卓基础四大组件知识点，可查看以下资料，网上也有很多资源可自行查询学习，内部也提供了对应视频资源讲解四大组件，具体见此服务器地址目录：ftp://192.168.0.6/安卓基础

活动：
https://blog.csdn.net/qq_35507234/article/details/82718794?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522160801676919195283016104%252522%25252C%252522scm%252522%25253A%25252220140713.130102334..%252522%25257D&request_id=160801676919195283016104&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-82718794.pc_search_result_no_baidu_js&utm_term=android%20activity
服务：
https://blog.csdn.net/pkorochi/article/details/81908218?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522160801731719725222454590%252522%25252C%252522scm%252522%25253A%25252220140713.130102334..%252522%25257D&request_id=160801731719725222454590&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-81908218.pc_search_result_no_baidu_js&utm_term=android%20service
广播：
https://blog.csdn.net/lyp_1020k/article/details/80305287?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522160801743019724838574760%252522%25252C%252522scm%252522%25253A%25252220140713.130102334..%252522%25257D&request_id=160801743019724838574760&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-80305287.pc_search_result_no_baidu_js&utm_term=android%20%E5%B9%BF%E6%92%AD
内容提供器：
https://blog.csdn.net/dmk877/article/details/50387741?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522160810718816780258030105%252522%25252C%252522scm%252522%25253A%25252220140713.130102334..%252522%25257D&request_id=160810718816780258030105&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_click~default-1-50387741.pc_search_result_no_baidu_js&utm_term=android%E5%86%85%E5%AE%B9%E6%8F%90%E4%BE%9B%E8%80%85



### 项目常规工作流程

#### 1. 配置环境

参见初级部分内容（内含repo、gerrit、AS）

#### 2. 代码拉取常用命令

根据客户需求拉取对应平台代码（1、内部存在该平台仓库代码，则直接拉取  2、有的则是客户提供代码，那需要拿到客户代码内部进行代码上库操作，具体可见代码上库及外发流程 本文第7点），

以6750N为例：

下载一个Repo项目，只需要三条命令：

```
$ repo init --no-repo-verify -u <URL> -m <manifest-file>
$ repo sync
$ repo start --all master
```

`repo init`中的使用到参数含义如下：

- `-u`：指定manifest仓库的路径，这是一个git仓库地址
- `-m`：指定manifest仓库中的某个manifest文件

例如，下载AndroidN 50项目海外公版本，注意修改yourname为你的名字。

```
$ repo init --no-repo-verify -u ssh://yourname@10.20.40.19:29418/freemeos/manifest -m ALPS-MP-N0.MP7-V1_DROI6755_66_N/pcb_oversea.xml
$ repo sync
$ repo start --all master
```

如果要下载驱动版本，请把repo init命令最后的`pcb_oversea.xml`改成`driver.xml`，下载production.xml同理。

repo start --all master  代表当前你将本地分支切换至master

#### 3. 代码编译与调试（整编和单编）

只介绍常用的几个命令，想深入了解请看第二步进阶中涉及点

##### 3.1 整编代码

首先在代码根目录下：
1、source build/envsetup.sh       	                            使用envsetup.sh脚本初始化环境
2、repoclean -a                                                          将编译产生的文件及修改未add的文件进行清除
3、repo sync                                                               更新仓库代码同步到最新（单仓库git 则可用git  pull）
4、repo start --all master                                          将repo管理的git仓库全部切换到本地master分支
5、repo rebase                                                           针对当前分支的跟踪分支执行rebase操作

一般来说可以开始编译代码了，但是平时很多时候仓库里都会有其他同事pick的提交，这个是repoclean -a 无法清除的，一般都要执行repo overview后查看当前本地是否有提交记录，若有，则进行节点回退。

repo overview `                                     查看是否有本地pick的提交记录

如果有提交的话需要cd到对应仓库手动回退掉
git log .                                                   查看当前仓库提交记录
git checkout .                                        清除所有文件的修改
git clean -df                                           删除未追踪的文件
git pull --rebase                                    更新git仓库代码                         
git revert                                                指定节点id     回退某笔提交                                                                                                                                                                git reset --hard 指定+节点id或者+HEAD~3数量                 回退本地仓库到指定节点   --hard不保存文件修改 --soft 不会回退修改的文件

提交命令：

1. git status .
2. git add .
3. git commit -m ""
4. git push

到这里准备工作完成，开始编译代码，如果非首次环境，则按上面步骤进行。如果是刚拉完的代码编译则直接可执行下面命令：

./mk -u -f  项目名 new`       ：编译普通user版本

./mk -u -f -s 项目名 new`                      `     ：编译签名普通user版本

./mk -u -f -s 项目名 ota`      ：编译带签名的ota user版本

```
./mk [options]... <prject_name> [actions] [args]
```

**参数含义：**

[options]
-l|--listp			         打印能够构建的产品目录
-u|--user			       编译 user 版本
-d|--userdebug		编译 userdebug 版本
-e|--eng			         编译 eng 版本
-s|--sign-image		编译签名软件
-f|--force-override breakfast  的时候强制覆盖

[actions]
new|n				       编一个新版本，会自动删除 out 和 breakfast
remake|r			      在上一次编译的基础上，重新编译一个版本
clobber|clean|c	  删除 out，或删除指定模块编译产物
systemimage|snod    编 systemimage
otapackage			  编 otapackage
ota					         等同于依次执行 new、otapackage 和 ./publish
clean-.+			         删除对应模块编译产物
preloader|pl		    编译 lk，等同于 make pl
lk					            编译 lk，等同于 make lk
kernel|k			        编译 kernel，等同于 make kernel
m|mmm|mmma	和单独使用这些命令的区别是，会在执行前，先 lunch

./publish                    打包编译好的软件



##### 3) 更多实现细节和预定义命令，可以阅读这些脚本

```shell
vendor/freeme/build/tools/build
vendor/freeme/build/envsetup.sh
vendor/freeme/build/envsetup-mtk.sh
vendor/freeme/build/envsetup-mtk.signimage.sh
```



##### 3.2 单编代码

当我们需要单独调试某个apk的时候可以单独编译该模块

以设置举例，单编freemesetting的命令为 

方式一：`

**source build/envsetup.sh --- lunch对应工程  --- mmm vendor/freeme/packages/apps/FreemeSettings/**

方式二：

**./mk -d -f q18_m10h vendor/freeme/packages/apps/FreemeSettings/**

方式三：

**./mk -d -f q18_m10h lk / bootimage / pl** 



单编模块后会有对应apk及路径显示，手机连接usb执行 adb root，adb remount， 确保手机有挂载上后可以使用adb install -r 或者adb push  + apk   + apk push到的.apk&.jar路径，单编push后记得清除应用缓存

1、常规应用使用如下命令： adb shell pm clear + 包名

2、Systemui使用如下命令：adb shell ps |grep systemui  查看对应进程pid 后执行 adb shell kill + pid

3、单编framework、framework-services.jar需要push至手机后重启手机方能生效

4、若单编涉及到SettingPrivider相关的修改，push之后需要恢复出厂设置方能生效

5、若单编preloader、boot、lk 则需要通过刷机单刷此bin后开机才能生效（编译lk之前需要touch图片目录，lk.bin才会更新或者删除lk.bin再执行编译）

​      a. 修改 logo 等资源，下载 logo.bin 和 lk.bin 即可生效

​      b. 修改 kernel，编译 `make bootimage`或 ./mk -d -f q18_m10h  bootimage，然后下载 boot.img 即可

​      c. 修改 camera 效果，`mmma vendor/mediatek/proprietary/custom/mt6758/hal` 把生成的库 push 到手机即可，一般 so 库会在 out 的 system 下面

​      d. 修改分区表后快速验证方法，先`make ptgen`，再 remake，就可以刷机进行验证了

**备注：**

但是在原生分支代码使用make -j8进行编译成功，但是进行mmm进行单编模块时编译时失败，则可以使用mmma 进行模块编译

 ninja: error: 'out/target/common/obj/JAVA_LIBRARIES/metrics-helper-lib_intermediates/classes-header.jar', needed by                               'out/target/common/obj/APPS/SystemUISharedLibTests_intermediates/classes-full-debug.jar', missing and no known rule to make it

09:39:22 ninja failed with: exit status 1

\#### failed to build some targets (05:40 (mm:ss)) ####



在整体编译时部分依赖测试不会进行编译，所以使用使用mmm时会提示依赖出错，此时应该用mmma进行编译。

mm 构建模块在当前文件夹，不构建依赖

mmm 构建模块指定路径，不构建依赖

mma 构建模块在当前文件夹并构建依赖

mmma 构建模块在当前文件夹并构建依赖

#### 4.举例AndroidN 架构基础知识，可供参考下链接，项目日常涉及，划重点

http://10.20.40.21:8081/plugins/gitiles/Freeme/FreemeIMP/documents/+/master/FreemeIMP/FAQ/FreemeOS_N%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.md



#### 5.将源码导入Android Studio进行调试

在编译成功的代码环境下

项目代码导入Androistudio中步骤：

为android studio创建android源码索引：

1. source build/envsetup.sh 
2. lunch +  工程分支名
3. mmm development/tools/idegen/
4. development/tools/idegen/idegen.sh

完成之后打开Android Studio点击"Open an existing Android Studio project"找到刚生成的"android.ipr"文件导入，第一次会很慢，几个小时不等。导入完成后，可以将相关目录进行锁定（选中对应文件夹---右键---MarkDirectory---Exclued），这样搜索代码关键字检索时会快一些



#### 6.客户项目流程

一个项目从立项到量产需要经历如下步骤：

##### 6.1  客户驱动修改推送 及 客户软件需求、项目配置表释放

​        需要客户提供项目硬件配置表，充电器，耳机，手机校准参数、软件需求表等；后根据客户驱动方案公司提供项目驱动patch找王静新建项目，检查对应渠道的releasenote，比如入库或者公开市场对应的宏开关是否配置正确；

##### 6.2  内部申请三号、申请客户预装apk及申请项目商务后台信息备案

​       根据客户释放的项目配置表（内存、项目性质<归属哪种项目性质：运营商渠道、公开市场渠道、电商渠道、线下渠道等>

​      （1）发邮件给lite陈娇、刘泽伟等去确定对应的项目预装<即三方的apk>及防覆盖文件

确定后陈娇会回复预装列表以及对应的预装目录（mtk平台与展讯平台apk预置目录文件夹会有差异）、刘泽伟会回复对应防覆盖文件;

预装列表

| 序号   | 应用列表     | 是否可卸载 | 预安装目录                       |
| ---- | -------- | ----- | --------------------------- |
| 1    | 卓易市场     | 否     | /system/priv-app            |
| 2    | 微米浏览器    | 否     | /system/priv-app            |
| 3    | 天气（最美天气） | 否     | /system/priv-app            |
| 4    | 搜狗输入法    | 否     | /system/app                 |
| 5    | 手机百度     | 是     | /system/vendor/operator/app |
| 6    | 地图（高德地图） | 是     | /system/vendor/operator/app |
| 7    | 搜狐新闻     | 是     | /system/vendor/operator/app |
| 8    | 今日头条     | 是     | /system/vendor/operator/app |
| 9    | 视频（爱奇艺）  | 是     | /system/vendor/operator/app |
| 10   | 掌阅       | 是     | /system/vendor/operator/app |
| 11   | 音乐（酷我音乐） | 是     | /system/vendor/operator/app |
| 12   | 京东       | 是     | /system/vendor/operator/app |
| 13   | 明星日历     | 是     | /system/vendor/operator/app |
| 14   | 有料看看     | 是     | /system/vendor/operator/app |
| 15   | UC浏览器    | 是     | /system/vendor/operator/app |

​      （2）发邮件给陈娇等提供方案商名称（方案商问客户）申请项目的客户号、渠道号、项目号（此三项关系到后面版本验收以及我司查询客户该项目刷机量），陈娇确定后回复邮件如下：

项目号信息：

| 小辣椒（L6 新模式） |                                          |
| ----------- | ---------------------------------------- |
| 客户号         | XIAOLAJIAO_MD                            |
| 渠道号         | XIAOLAJIAO_MD_HONGXIANGYUAN              |
| 项目号         | ro.build.freemeos_customer_br = Droi_L6_MD |

​        （3）发邮件给项目对应负责商务同事添加mcp项目后台信息，需添加后台之后验收同事才能完成版本验收的流程，提供信息如下：

​                  小辣椒 Q18-M10-216-VJVJ

​                  客户号 ：XIAOLAJIAO_MD

​                  渠道号：XIAOLAJIAO_MD_HONGXIANGYUAN

​                  项目号：Droi_L6_MD

​                  内     存:  4+64

​                  平     台: MT6758N

​                  预置APK：15个

​                  分辨率：480*960

​                  带efuse且重ROM

##### 6.3 客户项目工程创建，需求修改及bug修复

​      （1）找王静建好项目工程，如若是之前有类似工程，可自行创建（项目建立的时候必须检查一下对应渠道的releasenote，比如入库或者公开市场对应的宏开关）

​      （2）在添加三方应用后，确认下系统分区system分区大小是否可以，一般项目保证system剩余分区大小为大于500MB，确保在后期更新三方应用及其他修改之后能够正常ota升级（每个项目必须保证释放出去的版本能够ota升级，注意检查ota后台服务器配置），可以指令查看：adb shell df -h ，查看system对应项可用大小，如若空间小，则自行修改分区表，如若客户出贴片软件，请修改后提前将分区表同步至客户，避免产线出现刷机问题

​        对于展讯平台，比较特殊，存在固定分区和自动分区的区别，因为自动分区会出现增加app之后system分区超过之前的大小而ota升级失败，但是在编译的时候都不会有问题；这个在固定分区是不会出现的，因为固定了分区大小，所以编译的时候直接报错。所以一般展讯平台的项目都建议修改成固定分区，具体的可以咨询之前做过相应平台的同事如何修改。

​      （3）在分区大小确定好之后，编译版本制作ota，本地和后台都需要验证，项目接近稳定的时候就需要及时验证。签名带OTA版本编译指令：./mk -u -f -s project ota

​        正式版本必须是user版本，而且必须签名验收；正式版本编译完成之后，请先备份vmlinux（KE），symbols（NE），备份放到192.168.0.6服务器上，在对应月份对应客户对应版本号下备份；此文件用于之后遇到重启或者关机问题时提供给mtk分析(vmlinux，分析 KE 必须的文件，路径：alps/out/target/product/project_name/obj/KERNEL_OBJ/vmlinux；symbols，分析 NE 必须的文件，路径：out/target/product/project_name/symbols)，发给客户的版本请备份这两个文件

​      （4）编译完提交刷机包到签名服务器（192.168.150.30）登录对应客户账号，后等待签名验收完成，备份验收后刷机包，target包，具体签名后台操作流程参考：签名后台使用说明V2.5.pdf

​      （5）在签名验收完成之后需要验证OTA功能是否正常，安排测试，正式版本需要测试主管那边测试没有严重影响量产的问题才能够释放量产；在申请测试的邮件中，必须清晰写出软件的修改点，包括做的某个功能会影响什么模块，解决的什么bug，mantis上解决的bug导出来放到邮件中，方便测试验证；

​        N/O/P平台差分包指令：在根目录下执行 ./otadiff +当前版本 目标版本（例如V01代表当前,V02代表目标版本）

ota执行完之后会在执行目录生成update.zip和package.zip

​        update.zip ：将此文件拷贝到设备存储中，可以通过标准的Recovery模式进行手动升级或选择系统升级apk本地检测升级包

​        package.zip ：该包上传OTA服务器，供在线升级使用。

​        ota的操作可以参考《OTA升级包制作SOP.pdf》，注意检查ota服务器配置

​       备注：注意差分包制作，本地升级是否正常，后台配置能否检测到新包

​       假包验证：目前各平台支持当前验收版本升级到当前签名版本（V1101-verify.zip  OTA 到V1101-sign.zip）版本编译一次即可验证OTA，不像以前版本号加test，再次编译，编译完提交刷机包后台签名繁琐。真包验证：以前的量产版本升级到最新版本（V1101-V1102）

​      （6）若客户需要量产贴片软件客户想减少刷机及开机时间，我们这边去除预装三方，减少开机时间，若客户提出需要量产软件，需要内部金伟安那边测试没有严重影响量产的问题才能够释放量产；每个项目的量产版本都必须带efuse（重rom项目会带此功能，少部分轻rom也会带此功能），并且通过生产工具验证后台有刷机数据；让对接客户及时验证，先刷1-2台，然后告诉你，去找陈斌查后台数据是否正常上报。数据正常则ok，工厂第一次贴片，需要安排外派FAE技术支持，先刷1-2台，然后告诉你，你去找陈斌查后台数据是否正常上报。数据正常则ok

##### 6.4 申请efuse相关patch移植 以及 客户产线刷机工具申请

​        场景一：客户为重ROM项目（除驱动方面以外，其余代码功能相关都使用我们提供的），则进行如下操作

​        发邮件给工具组薛伟力等，遇到新的客户，新的项目需要发邮件找工具组申请新的Secure Boot key，key值提交到项目主板上（针对8.0及以下平台）8.0以上平台key已放到后台，签名时会对上传的版本中镜像文件进行签名，无需提交至项目主板，并找他们提供对应客户的刷机工具，项目量产前进行签名与验收，确保验收没有问题以及确保客户机器是否支持熔断（并通过生产工具验证后台有刷机数据，有无数据找陈斌进行确认），确认后将工具释放至客户；

​        场景二：客户为轻ROM项目（除驱动方面以外，其余只添加我们的安全服务、桌面、以及三方预装），则进行如下操作

​        有些特殊项目不需要刷机费的，那就不要上efuse，这个时候需要特别注意：

​        1、工厂生产使用的是mtk的刷机工具，我们最多只提供mtk原始工具；

​        2、如果有预装app，那么找客户上传后台申请验收，验收同事会验证预装及安全桌面相关是否符合规范

​        场景一场景二都另申请后台版本签名网址的账号和密码（例如华尔博思客户账号密码为huaerbosi huaerbosi013）已存在的客户会有对应账号此申请可不做，具体可见客户ftp账号.xlns

**6.5** **刷机**

MTK版本刷机可使用FlashTool （需要安装mtk驱动） 或者多录工具进行刷机，展讯版本刷机使用ResearchDownloadxxx，刷机会常遇到错误，请参见tower上：刷机常见错误.doc

##### 6.6 版本释放，项目版本后期维护

​      发送邮件给客户，列出版本路径、OTA路径、修改点等



简述外发正式项目软件版本流程

出版本流程,必须掌握：
        (1)修改bug及需求,修改软件版本号递增.并确认提交的代码都已经入库(弄清提交代码所处各种状态)
        (2)如何清理out及编译环境，更新代码，编译软件
        (3)提交签名后台，签名，验收 (签名版本存放路径150.168.150.30), 签名后台地址http://sign.ttddsh.com:2030/index, 
        (4)取验收后或者签名后的版本刷机，检查修改点是否生效，找测试主管安排测试
        (5)验收后的版本自动保存在upload.droi.com里，可以同步问下验收同事版本各项验收指标是否达标
        (6)Tower上新建任务，抄送客户及我们内部测试人员， 版本路径是upload.droi.com里的路径.，并列出所有修改点
        (7)版本测试合格后，做ota升级包， 并在测试后台测试发布.，写入白名单里的IMEI号，验证是否能升级成功。ota包要做2个，双向的， 比如V1101和V1102版本（真包），V1102-V1102Sign版本（假包）； V1102和V1101（倒包）                                                                                                                                                           



#### 7.项目常见问题及常见修改点

一、期间除了完成工作中需要完成的任务以外, 还需要完成如下任务：
​       如下问题在58P平台,以Q5712-CP-1GF项目为例.
​       1, 项目软件版本号怎么修改? 版本号修改的原则是什么？
​       2, 项目三号如何修改
​       3, 项目分支下,overlay和override的区别是什么? 分别适合在那种情况下用?
​       4, 系统预装与第三方预装的apk在平台的具体路径? 怎么预置或删减其中一个?
​       5, 如何判断一个apk是否是V2签名? V2签名的apk预装(Android.mk)要怎么处理防止预装进去应用图标不显示在桌面.
​       6, apk可以预装到系统的哪些路径下? 区别是什么?
​       7, 系统默认壁纸及预置壁纸具体路径?目前放到每个项目的wallpapers下,为啥能生效?
​       8, 桌面(Launcher)在平台的具体路径,桌面布局是哪个文件? 桌面布局里面launcher:x ,launcher:y ,launcher:screen 分别代表的含义?
​       9, 设置中 "电子说明书"的代码路径? 怎么删减?
​      10,ota配置项如何修改
​      11,项目分支下prebuilts目录的作用?
​      12,拨号盘暗码的添加流程? 例如*#06# , *#6813#，以及修改暗码在哪个目录哪个文件中进行修改，以及注意事项是什么？
​      13,项目手机存储ram/rom、屏幕尺寸、型号、品牌、设备名称、蓝牙名称等如何进行修改？
​      14,device/droi/common/device.mk  device/mediatek/common/device.mk  device/droi/g1863/device.mk 这3个有什么关联? ProjectConfig.mk文件呢?
​      15,开关机动画怎么怎么制作? 开关及动画在平台的具体路径. 开机动画前会加载两张静态图片,分别是哪两张? 在平台的具体路径? 目前放在bootanimation目录下, 为啥能生效?
​      16,设置中的一些默认值: 屏幕亮度默认值,铃声通知音大小如何设置？自动调节亮度开关,"导航栏可隐藏", "虚拟导航栏默认形式" ,红包助手, 单手模式, 三指截屏,   默认打开或关闭的开关?

先学习以上部分常见配置项修改，学习后进行完善以及后续补充 !



#### 8.客户代码内部上库流程以及内部代码外发流程

##### 8.1 客户提供驱动代码内部上库步骤

​     1、解压代码例如：cat xxx.tar.gz* | tar -zxv

​     2、解压后：find -name .git |xargs rm -rf   删 .git  

​     3、创建manifast下的布局xml，如图

![img]![](res\2.png)

​      将—common.xml以及sprd.xml中新建仓库名称进行全部替换

![img]![](res\3.png)

​     替换后执行：

​     ./creategit.sh s0 ../pub/p60/.repo/manifests/ALPS-MP7-O1/_common.xml

​     注： ../pub/p60/.repo/manifests/ALPS-MP7-O1/_common.xml  这是参照其他项目复制的一个，要修改路径，确保根目录文件夹都包括

​     对比project.gerrit 和project.list（生成在项目下），确保两项仓库数量一致，与解压的仓库数量进行对比，如下图：

![img]![](res\4.png)

​     4、./creategit.sh s1   (create git list)

​     5、./creategit.sh s2   (create branch)

​     6、./creategit.sh s3   (code push)

​     7、./creategit.sh s4   (code review)

​     8、create branch  点击create 会自动填充HEAD节点

##### 8.2 内推代码至客户两种方式

方式一：

​      1、拉取对应仓库代码

​      2、备份编译版本指令及ota指令（vendor/freeme/build/ 目录下 的 envsetup-mtk.sh和 envsetup-mtk.signimage.sh ），若客户使用我们的编译架构，则备份脚本进行提供；执行 repo forall  -p -c 'git log -1 -r' > 项目+日期.txt （此文件保留备份），将当前代码仓库所处提交节点全部提取出来，方便下次更新patch进行仓库节点对比

​      3、执行：source build/envsetup.sh 后执行 publication （此命令会删除 .repo .git 以及内部平台签名<vendor/freeme/build/>,build目录会进行删除，执行后进行检查是否执行成功）

​      4、压缩代码 ： tar -czf - MT6737_2.164.3 | split -b 1024m -d - MT6737_2.164.3.tar.gz   压缩完成，上传至对应客户ftp，并提供给客户解压指令：cat MT6737_2.164.3.tar.gz* | tar -zxv

备注：

执行1-4步为首次推送外部patch，将整个仓库代码打包，后续有新增需求bug修改等需要再次给客户同步patch时，需要再次提取当前最新所处提交节点项目+日期.txt ，与上次外推的项目+日期.txt 进行文件对比，确定有差异更新部分的仓库需要执行该脚本（脚本见资料整理.zip）将更新的修改提取出来，执行命令：

./diff_new_old.sh  上次推送时处于的节点  此次更新时处于的节点  + 生成patch目录名称

方式二：

​      请参考如何将项目代码部署到外部gerrit上

http://10.20.40.21:8081/plugins/gitiles/Freeme/FreemeIMP/documents/+/master/FreemeIMP/FAQ/%E5%A4%96%E9%83%A8gerrit%E9%83%A8%E7%BD%B2%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B.md

## 

#### 9.patch提取与打入

​    可参考此链接进行操作： https://blog.csdn.net/liuhaomatou/article/details/54410361

   

#### 10.一些需要理解的概念

##### 1、软件版本分类

1. 1

   软件项目版本分为非签名版本即普通版本（eng/debug/user）、签名版本（debug/user-目前不支持eng版本签名）、验收版本（user-释放给客户的正式版本），以下三种版本的区别为：

​      （1）普通版本：即不含Secure Boot功能的版本，mtk释放的代码secure boot功能是默认关闭的，版本压缩包后缀为：xxx.zip （含原生驱动版本以及FreemeOS版本）

​      （2）签名版本：即打开了Secure  Boot功能的版本，版本压缩包后缀为：xxx_signed.zip

​      （3）验收版本：即打开了Secure  Boot功能的版本，经验收后的机器开机桌面不带"未熔丝、未认证"水印字样，版本压缩包后缀为：xxx_signed_verified.zip

1. 2

​        手机刷机后版本区分

​        以上三种版本开机后桌面上都会带有水印字样"未熔丝、未认证"，机器如果被熔断，则只显示"未认证"字样；机器未被熔断，但刷了验收版本，则只会显示"未熔丝"字样；一般有客户想在临时软件版本上去除水印，可执行如下命令：adb shell am broadcast -a android.droi.watermark.SECRET_CODE

​        熔断的手机无法刷普通版本，只能用签名或者验收的版本去刷机，才可成功，查看手机是否被熔断，可以开机看手机水印是否还有显示”未熔丝“字样，没有显示则表示手机已被熔丝；或者通过adb 命令去查看如图（为no则表示手机未熔断）：

​        adb shell getprop|grep ro.efused  如果显示[ro.efused]:[no]，则表示手机未被熔丝

​        是否签名或验收的软件刷到机器里面会被熔断？

​        签名或者验收的软件本身不对机器进行熔丝操作，熔丝操作是在多录工具下载成功软件之后，多录工具对手机芯片本身进行烧写，所以只有工具组薛伟力他们那边释放的工厂贴片以及在线升级工具会对手机进行熔断以外，其他的工具不会对手机进行熔断

备注：什么是secure boot?

​        MTK平台Secure boot方案的主要作用是防串烧，意思就是xx品牌手机卖到用户手中之后， 用户只能下载和升级经过xx品牌签名的镜像，非xx品牌厂商提供的镜像是不能烧录到xx品牌手机上的，避免手机串刷



##### 2、刷机工具的分类（MTK平台与展讯平台）

2.1 MTK单录工具，即FlashTool工具

​       目前mtk原生释放的配置不会对手机进行熔断（若刷签名版本将原生自带MTK_AllInOne_DA.bin替换为对应客户的MTK_AllInOne_DA-BODAO.bin《客户的DA文件在工具组释放的多录工具中会携带》）

2.2 MTK多录刷机工具

​       在项目即将达到量产状态时，内部工具组会释放三个工具，如下：

​       工厂贴片工具（XXX_FACTORY_V1.zip）：下载软件可执行格式化下载，手机会被熔断，但务必保证电脑网络连接可用（否则工具将无法使用），烧录成功并上传数据之后会提示“upload ok”

​        在线升级工具(XXX_ONLINE_UPGRADE_V1.zip)：同工厂贴片工具使用方式，差别除下载软件无格式化下载功能

​        离线升级工具(XXX_OFFLINE_UPGRADE_V1.zip)：只会提供固件升级功能，无法进行手机熔丝，无数据上报

2.3 展讯刷机工具

​       ResearchDownloadxxx（xxx对应工具版本号）

2.4 展讯刷机及熔断手机工具

​      工厂贴片工具：FactoryDownload_R24.0.0003_XIAOLAJIAO_MD_V1.zip（此工具会格式化校准参数）

​      在线升级工具：UpgradeDownload_R24.0.0003_XIAOLAJIAO_MD_V1.zip （此工具会保留校准参数，刷机前手机需有校准参数，否则刷机会报无参数异常）

​      多路efuse工具：MultiSecureBoot_XIAOLAJIAO_MD_V1.zip（该工具执行熔丝操作以及站位信息配置，具体操作说明见压缩包解压后\Doc目录）

2.5 工具组工具做好之后会存放FTP路径

​       对应ftp addr：192.168.150.30    ftp name：tooluser    ftp pwd：  tooluser999

##### 3、写号工具分类（MTK平台与展讯平台）

​      3.1 MTK平台：SN Writer （需要提供对应软件版本的ap、bp文件才能写号）

​      3.2 展讯平台：Simba  （可直接写号）

​      工具具体操作方式可咨询测试



#### 工作中的常犯错误禁忌项

禁忌：

1、针对自己负责的相关客户，客户询问其他的客户信息不要透露，也不要将内部在做的重要事项透漏给方案客户，例如着手在开发哪个新平台

2、若有客户要求定制主题，定制后则其他客户项目不可再进行使用该套主题。也不可将主题提供给其他客户内置，避免引起投诉

3、OTA正式发布需要让测试验证升级通过后才可叫各组对应主管进行发布，客户发版本的项目需要让客户OTA升级验证后客户邮件提出正式释放内部才可正式发布

4、量产前需要与客户确定是否系统相关分区已调整ok，量产后不可再对分区进行调整

5、验收版本提到安全服务版本低时，外推更新安全服务apk时，请将名称改为销量统计apk

待各自进行补充 .....



### 项目量产后需求问题归纳总结



待各自进行补充 .....



## 学习计划及目标，学习成果检测

一、短期内需要了解掌握的知识点及需要达到的目标

​       1.override和overlay的区别
​       2.项目编译时，项目里的文件都对应了公版的哪些文件
​       3.android四大组件
​       4.android原生编译命令
​       5.apk编译与反编译的区别及如何编译反编译
​       6.简单的shell脚本，比如自己写一个新建项目的脚本
​       7.认识一些常见的驱动文件，比如相机差值，屏驱动
​       8.分区表
​       待各自进行补充 .....

二、在学习完安卓基础的基础上，完成如下项目功能点开发，以下作为三个月学习成果检测的标准

​       手机卫士APP项目

​       包含功能：手机防盗、通讯黑名单、软件管理、进程管理、流量统计、手机杀毒、缓存清理、程序锁等）

​       1、功能实现要求：是平时安全卫士里面的一键结束程序。程序管理器可以查看以安装的程序列表和储存剩余信息。流量统计可以检测不同程序的流量使用情况。  还有一个手机杀毒功能不知道是凭什么判断的安全，缓存扫描清理应该是列出了缓存内容超过一定大小的程序点击程序名称可以在系统界面进行缓存清理等

​       手电筒应用(界面可以简单，功能实现要求：
​       1、手电筒应用打开后需要有具体的界面打开和关闭按钮. 并实现打开手电筒 和 关闭手电筒的操作
​       2、手电筒应用的打开和关闭状态 必须和手机下拉栏的手电筒状态一致,相反的下拉栏的手电筒状态也要和手电筒应用保持一致

​     以上，自己写的代码, 要能讲出来怎么实现的.

三、工作之余书籍参考：安卓第一行代码、疯狂Android讲义



### 项目工作需要用到的网址：

​        1、OTA后台管理  网址 http://ota.yy845.com:2970/   （通过此配置OTA包用于修复量产软件上已解决的问题）

​        账号：IMP  密码： IMP*#2020  （OTA正式发布请找对应主管进行操作）

​        2、版本签名验收管理 网址：http://sign.ttddsh.com:2030/ 

​        账号密码根据客户进行区分，具体可见：账号密码备忘录.xls （根据这些账号可以通过FTP取到对应签名及验收软件版本）

​        3、Mantis Bug管理网址： http://bug.droi.com/mantis4/login_page.php    

​        账号：Your Name 密码：默认无（自行设定）

​        4、MTK平台资料查询网址： https://online.mediatek.com   

​              备注：如需下载文档，下载后查看文档密码：4122540868 6322477226 3491484993 （可分别用这三组密码）

​              MTK平台E：https://eservicesso.mediatek.com/eservice-portal/dashboard/

​              备注: 用于提问给MTK 分析解决严重疑难问题

​              MTK平台大文件传输网址： https://transfer.mediatek.com/ 

​              备注: 用于传输MTK 严重疑难问题log过大情况下通过此途径上传给MTK

​              MTK相关 统一使用账号：jiangnan@droi.com    密码：Droi2020   

​              ftp://192.168.0.6   常用的一些MTK工具与Bug log会放在上面 （账号：tydswuser  密码： tyduser）

​         5、 百度云盘账号: 13817009710   密码: tyd1111 （平时可根据客户需求释放代码版本，拿取客户问题Log等）

​        待各自进行补充 .....

   
